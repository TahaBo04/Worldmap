<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Our Pre-Marriage Travel Map</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root{
      --accent:#00e38a;
      --bg:#0b0b0b;
      --panel:#151515;
      --text:#f5f5f5;
      --muted:#9aa1a7;
    }
    *{box-sizing:border-box}
    body{
      margin:0; background:var(--bg); color:var(--text); font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial;
      display:grid; grid-template-columns: 340px 1fr; height:100vh;
    }
    /* Sidebar */
    aside{
      background:var(--panel); border-right:1px solid #222; padding:16px 14px; overflow:auto;
    }
    h1{font-size:18px; margin:0 0 8px}
    .base{font-size:13px; color:var(--muted); margin-bottom:12px}
    .controls{display:grid; gap:10px; margin-bottom:10px}
    .search{display:flex; gap:8px}
    .search input{flex:1; padding:8px 10px; border-radius:8px; border:1px solid #2a2a2a; background:#0f0f10; color:var(--text)}
    .filters{display:flex; flex-wrap:wrap; gap:6px}
    .tag{font-size:12px; padding:6px 8px; border-radius:999px; border:1px solid #2a2a2a; cursor:pointer; user-select:none}
    .tag.active{border-color:var(--accent); color:#111; background:var(--accent)}
    .progress{margin:8px 0 12px}
    .bar{height:8px; background:#242424; border-radius:999px; overflow:hidden}
    .bar > span{display:block; height:100%; background:var(--accent); width:0%}
    .summary{font-size:12px; color:var(--muted); margin-top:6px}
    .actions{display:flex; gap:8px; margin:10px 0 14px}
    button{
      background:transparent; border:1px solid #2a2a2a; color:var(--text); padding:8px 10px; border-radius:8px; cursor:pointer
    }
    button:hover{border-color:var(--accent)}
    input[type="file"]{display:none}

    /* List */
    ul{list-style:none; padding:0; margin:0; display:grid; gap:6px}
    li{
      display:flex; align-items:center; gap:10px; padding:8px; border:1px solid #222; border-radius:10px; background:#101012
    }
    li small{color:var(--muted)}
    .pill{font-size:11px; padding:3px 8px; border-radius:999px; border:1px solid #2a2a2a}
    .pill.same_day{color:#7bdfff;border-color:#164a7a}
    .pill.weekend{color:#ffd27b;border-color:#6a4c11}
    .pill.multi_day{color:#ff9aac;border-color:#5a1822}
    .pill.abroad{color:#b59bff;border-color:#40346a}
    .visited{color:#79f7b8}
    .muted{color:var(--muted)}
    .grow{flex:1}

    /* Map */
    #map{height:100vh; width:100%}
    .leaflet-popup-content{margin:8px 12px}
    .popup-title{font-weight:600}
    .popup-row{font-size:12px; color:#666}
    .popup-btn{margin-top:8px; display:inline-block; padding:6px 10px; border:1px solid #ddd; border-radius:8px; cursor:pointer}
  </style>
</head>
<body>
  <aside>
    <h1>Our Pre-Marriage Travel Map</h1>
    <div class="base">Base: Rabat / Salé • Be home by 20:00–21:00</div>

    <div class="controls">
      <div class="search">
        <input id="q" type="text" placeholder="Search places…" />
        <button id="clearQ">Clear</button>
      </div>
      <div class="filters" id="filters">
        <span class="tag active" data-cat="all">All</span>
        <span class="tag" data-cat="same_day">Same-day</span>
        <span class="tag" data-cat="weekend">Weekend/Long day</span>
        <span class="tag" data-cat="multi_day">Multi-day (2–3+)</span>
        <span class="tag" data-cat="abroad">Outside Morocco</span>
      </div>
      <div class="progress">
        <div class="bar"><span id="bar"></span></div>
        <div class="summary" id="summary">0 / 0 visited</div>
      </div>
      <div class="actions">
        <button id="exportBtn">Export progress</button>
        <label for="importFile" class="btn"><button>Import</button></label>
        <input id="importFile" type="file" accept="application/json" />
        <button id="resetBtn">Reset</button>
      </div>
    </div>

    <ul id="list"></ul>
  </aside>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ---- DATA ------------------------------------------------------------
    // Tip: add your own easily; lat/lng can be updated later if needed.
    const PLACES = [
      // === Same-day (≤ ~2h each way) ===
      {id:"rabat", name:"Rabat", cat:"same_day", country:"Morocco", lat:34.020882, lng:-6.841650},
      {id:"sale", name:"Salé", cat:"same_day", country:"Morocco", lat:34.053, lng:-6.798},
      {id:"temara", name:"Temara", cat:"same_day", country:"Morocco", lat:33.928, lng:-6.913},
      {id:"skhirat", name:"Skhirat", cat:"same_day", country:"Morocco", lat:33.851, lng:-7.040},
      {id:"bouznika", name:"Bouznika", cat:"same_day", country:"Morocco", lat:33.788, lng:-7.150},
      {id:"mohammedia", name:"Mohammedia", cat:"same_day", country:"Morocco", lat:33.694, lng:-7.389},
      {id:"kenitra", name:"Kénitra", cat:"same_day", country:"Morocco", lat:34.261, lng:-6.580},
      {id:"mehdia", name:"Mehdia Beach", cat:"same_day", country:"Morocco", lat:34.264, lng:-6.674},
      {id:"oulja", name:"Oulja (Salé)", cat:"same_day", country:"Morocco", lat:34.047, lng:-6.760},
      {id:"sidi_bouknadel", name:"Sidi Bouknadel (Jardin Exotique)", cat:"same_day", country:"Morocco", lat:34.064, lng:-6.742},
      {id:"sidi_yahya_zaer", name:"Sidi Yahya Zaer", cat:"same_day", country:"Morocco", lat:33.807, lng:-6.873},

      // === Weekend / Long-day (2–3h) ===
      {id:"casa", name:"Casablanca", cat:"weekend", country:"Morocco", lat:33.573, lng:-7.589},
      {id:"el_jadida", name:"El Jadida", cat:"weekend", country:"Morocco", lat:33.254, lng:-8.507},
      {id:"azemmour", name:"Azemmour", cat:"weekend", country:"Morocco", lat:33.290, lng:-8.342},
      {id:"moulay_bousselham", name:"Moulay Bousselham", cat:"weekend", country:"Morocco", lat:34.879, lng:-6.287},
      {id:"ifrane", name:"Ifrane", cat:"weekend", country:"Morocco", lat:33.533, lng:-5.110},
      {id:"azrou", name:"Azrou", cat:"weekend", country:"Morocco", lat:33.436, lng:-5.221},
      {id:"chefchaouen", name:"Chefchaouen", cat:"weekend", country:"Morocco", lat:35.171, lng:-5.269},

      // === Multi-day (2–3+ days) ===
      {id:"marrakech", name:"Marrakech", cat:"multi_day", country:"Morocco", lat:31.629, lng:-7.981},
      {id:"agadir", name:"Agadir", cat:"multi_day", country:"Morocco", lat:30.427, lng:-9.598},
      {id:"ouarzazate", name:"Ouarzazate", cat:"multi_day", country:"Morocco", lat:30.919, lng:-6.893},
      {id:"ait_ben_haddou", name:"Aït Ben Haddou", cat:"multi_day", country:"Morocco", lat:31.048, lng:-7.131},
      {id:"merzouga", name:"Merzouga (Erg Chebbi)", cat:"multi_day", country:"Morocco", lat:31.100, lng:-4.000},
      {id:"tetouan", name:"Tétouan", cat:"multi_day", country:"Morocco", lat:35.574, lng:-5.368},
      {id:"mdiq", name:"M’diq", cat:"multi_day", country:"Morocco", lat:35.683, lng:-5.320},

      // === Abroad (later) ===
      {id:"tarifa", name:"Tarifa", cat:"abroad", country:"Spain", lat:36.013, lng:-5.607},
      {id:"seville", name:"Seville", cat:"abroad", country:"Spain", lat:37.389, lng:-5.984},
      {id:"granada", name:"Granada", cat:"abroad", country:"Spain", lat:37.178, lng:-3.600},
      {id:"lisbon", name:"Lisbon", cat:"abroad", country:"Portugal", lat:38.722, lng:-9.139},
      {id:"porto", name:"Porto", cat:"abroad", country:"Portugal", lat:41.149, lng:-8.610},
      {id:"paris", name:"Paris", cat:"abroad", country:"France", lat:48.8566, lng:2.3522},
      {id:"marseille", name:"Marseille", cat:"abroad", country:"France", lat:43.296, lng:5.369},
      {id:"rome", name:"Rome", cat:"abroad", country:"Italy", lat:41.9028, lng:12.4964},
      {id:"florence", name:"Florence", cat:"abroad", country:"Italy", lat:43.7696, lng:11.2558},
      {id:"venice", name:"Venice", cat:"abroad", country:"Italy", lat:45.4408, lng:12.3155}
    ];

    // Colors for categories and visited state
    const CAT_COLOR = {
      same_day:'#6bc2ff',
      weekend:'#ffc85a',
      multi_day:'#ff7a93',
      abroad:'#c0a6ff'
    };
    const VISITED_COLOR = '#19f5a6';

    // ---- STATE -----------------------------------------------------------
    const KEY = 'travelmap.visited.v1';
    let visited = new Set(JSON.parse(localStorage.getItem(KEY) || '[]'));
    let activeCat = 'all';
    let searchQ = '';

    // ---- MAP -------------------------------------------------------------
    const map = L.map('map',{worldCopyJump:true});
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      maxZoom: 18, attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    // Mark Rabat base with a different marker ring
    function circle(p, color, filled=true){
      return L.circleMarker([p.lat, p.lng],{
        radius: 8, weight: 2, color: color, fill: filled, fillOpacity:0.9, opacity:1
      });
    }

    const markersById = new Map();
    function addMarkers(){
      PLACES.forEach(p=>{
        const color = visited.has(p.id) ? VISITED_COLOR : CAT_COLOR[p.cat] || '#ddd';
        const m = circle(p, color, true)
          .addTo(map)
          .bindPopup(renderPopup(p));
        m.on('click', ()=> m.setStyle({color: visited.has(p.id)?VISITED_COLOR:(CAT_COLOR[p.cat]||'#ddd')}));
        markersById.set(p.id, m);
      });
      // Fit to Morocco first
      map.setView([33.8, -6.1], 6);
    }

    function renderPopup(p){
      const v = visited.has(p.id);
      const btn = `<button class="popup-btn" onclick="toggleVisited('${p.id}')">${v?'Mark as not visited':'Mark as visited'}</button>`;
      return `<div class="popup">
        <div class="popup-title">${p.name}</div>
        <div class="popup-row">${p.country} • <span class="pill ${p.cat}">${label(p.cat)}</span></div>
        ${btn}
      </div>`;
    }

    // ---- LIST / UI -------------------------------------------------------
    const listEl = document.getElementById('list');
    const barEl = document.getElementById('bar');
    const sumEl = document.getElementById('summary');
    const qEl = document.getElementById('q');
    const clearQ = document.getElementById('clearQ');
    const filtersEl = document.getElementById('filters');

    function label(cat){
      return ({
        same_day:'Same-day',
        weekend:'Weekend/Long day',
        multi_day:'Multi-day',
        abroad:'Abroad'
      })[cat] || cat;
    }

    function save(){
      localStorage.setItem(KEY, JSON.stringify([...visited]));
    }

    function updateProgress(){
      const total = PLACES.length;
      const done = visited.size;
      const pct = total? Math.round(done*100/total):0;
      barEl.style.width = pct + '%';
      sumEl.textContent = `${done} / ${total} visited (${pct}%)`;
    }

    function renderList(){
      const q = searchQ.trim().toLowerCase();
      listEl.innerHTML = '';
      PLACES
        .filter(p => (activeCat==='all' || p.cat===activeCat))
        .filter(p => !q || p.name.toLowerCase().includes(q) || p.country.toLowerCase().includes(q))
        .forEach(p=>{
          const li = document.createElement('li');
          const chk = document.createElement('input');
          chk.type = 'checkbox';
          chk.checked = visited.has(p.id);
          chk.addEventListener('change', ()=> toggleVisited(p.id));

          const name = document.createElement('div');
          name.className = 'grow';
          name.innerHTML = `<div>${p.name} ${visited.has(p.id)?'<span class="visited">✓</span>':''}</div>
                            <small class="muted">${p.country}</small>`;

          const cat = document.createElement('span');
          cat.className = `pill ${p.cat}`;
          cat.textContent = label(p.cat);

          li.appendChild(chk);
          li.appendChild(name);
          li.appendChild(cat);
          listEl.appendChild(li);
        });
    }

    // ---- INTERACTION -----------------------------------------------------
    window.toggleVisited = function(id){
      if(visited.has(id)) visited.delete(id);
      else visited.add(id);
      save();
      // update marker color & popup
      const p = PLACES.find(x=>x.id===id);
      const m = markersById.get(id);
      if(m){ m.setStyle({color: visited.has(id)?VISITED_COLOR:(CAT_COLOR[p.cat]||'#ddd')}); m.bindPopup(renderPopup(p)); }
      renderList(); updateProgress();
    }

    qEl.addEventListener('input', ()=>{ searchQ = qEl.value; renderList(); });
    clearQ.addEventListener('click', ()=>{ qEl.value=''; searchQ=''; renderList(); });

    filtersEl.addEventListener('click', (e)=>{
      const tag = e.target.closest('.tag'); if(!tag) return;
      [...filtersEl.querySelectorAll('.tag')].forEach(t=>t.classList.remove('active'));
      tag.classList.add('active');
      activeCat = tag.dataset.cat;
      renderList();
    });

    document.getElementById('exportBtn').addEventListener('click', ()=>{
      const data = { visited:[...visited], version:1, exportedAt:new Date().toISOString() };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'travel-progress.json';
      a.click();
      URL.revokeObjectURL(a.href);
    });

    document.getElementById('importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = ()=> {
        try{
          const obj = JSON.parse(reader.result);
          visited = new Set(obj.visited || []);
          save(); renderList(); updateProgress();
          // refresh markers
          PLACES.forEach(p=>{
            const m = markersById.get(p.id);
            if(m) m.setStyle({color: visited.has(p.id)?VISITED_COLOR:(CAT_COLOR[p.cat]||'#ddd')})
                  .bindPopup(renderPopup(p));
          });
          alert('Import successful ✅');
        }catch(err){ alert('Invalid file'); }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    document.getElementById('resetBtn').addEventListener('click', ()=>{
      if(confirm('Reset all visited places?')){ visited = new Set(); save(); renderList(); updateProgress();
        PLACES.forEach(p=>{ const m=markersById.get(p.id); if(m) m.setStyle({color:CAT_COLOR[p.cat]||'#ddd'}).bindPopup(renderPopup(p));});
      }
    });

    // ---- INIT ------------------------------------------------------------
    addMarkers();
    renderList();
    updateProgress();
  </script>
</body>
</html>
